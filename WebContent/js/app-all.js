/*
Copyright(c) 2012 Company Name
*/
Ext.define("AM.controller.Invoices",{extend:"Ext.app.Controller",views:["invoice.SupplierList","invoice.SupplierEdit","invoice.CentralList","invoice.CentralEdit"],refs:[{ref:"supplierList",selector:"invoiceSupplierList"},{ref:"centralList",selector:"invoiceCentralList"}],init:function(){this.control({invoiceSupplierList:{itemdblclick:this.editSupplierInvoice,render:function(){this.getSupplierList().getStore().load({params:{start:0}})},afterrender:function(){var b=this.getSupplierList().getPlugin("expander");var a=this;b.view.on("expandbody",function(e,d,c,f){Ext.Ajax.request({url:"invoice/processedInvoices.html?id="+d.getId(),method:"GET",success:function(g){c.innerHTML=g.responseText;a.getSupplierList().doLayout()},failure:function(){}})},this)}},"invoiceSupplierList #add":{click:this.addSupplierFormInvoice},"invoiceSupplierList #delete":{click:this.deleteSupplierInvoice},"invoiceSupplierList #export-excel":{click:function(){this.exportInvoices(0,"xls")}},"invoiceSupplierList #export-pdf":{click:function(){this.exportInvoices(0,"pdf")}},"invoiceSupplierList #searchBtn":{click:this.searchSupplierInvoice},"invoiceSupplierEdit button[action=save]":{click:this.updateSupplierInvoice},invoiceCentralList:{itemdblclick:this.editCentralInvoice,render:function(){this.getCentralList().getStore().load({params:{start:0}})}},"invoiceCentralList #add":{click:this.addCentralFormInvoice},"invoiceCentralList #delete":{click:this.deleteCentralInvoice},"invoiceCentralList #export-excel":{click:function(){this.exportInvoices(1,"xls")}},"invoiceCentralList #export-pdf":{click:function(){this.exportInvoices(1,"pdf")}},"invoiceCentralList #searchBtn":{click:this.searchCentralInvoice},"invoiceCentralEdit button[action=save]":{click:this.updateCentralInvoice}})},editSupplierInvoice:function(c,b){var a=Ext.widget("invoiceSupplierEdit",{isNewForm:false});a.down("form").loadRecord(b)},editCentralInvoice:function(c,b){var a=Ext.widget("invoiceCentralEdit",{isNew:false});a.down("form").loadRecord(b)},updateSupplierInvoice:function(d){var f=d.up("window"),e=f.down("form"),b=e.getRecord(),c=e.getValues();var a=b==null?true:false;if(e.getForm().isValid()){e.getForm().submit({url:a?"invoice/create.html":"invoice/update.html",scope:this,success:function(){f.close();this.getSupplierList().getStore().load()}})}},updateCentralInvoice:function(d){var f=d.up("window"),e=f.down("form"),b=e.getRecord(),c=e.getValues();var a=b==null?true:false;if(e.getForm().isValid()){e.getForm().submit({url:a?"invoice/create.html":"invoice/update.html",scope:this,success:function(){f.close();this.getCentralList().getStore().load()}})}},addSupplierFormInvoice:function(){Ext.widget("invoiceSupplierEdit")},addCentralFormInvoice:function(){Ext.widget("invoiceCentralEdit")},deleteSupplierInvoice:function(){var a=this.getSupplierList().selModel.getSelection();if(a.length==0){Ext.Msg.alert(DELETE_INVOICE_MSG_TITLE,DELETE_INVOICE_MSG_ALERT)}else{Ext.Msg.confirm(DELETE_INVOICE_MSG_TITLE,DELETE_INVOICE_MSG_CONFIRM,function(b,d){if(b=="yes"){var c=new Array();Ext.each(a,function(e){c.push(e.data)},this);Ext.Ajax.request({url:"invoice/deletes.html?",method:"POST",jsonData:c,scope:this,success:function(){this.getSupplierList().getStore().load()},failure:function(){Ext.Msg.alert(DELETE_INVOICE_MSG_TITLE,DELETE_INVOICE_MSG_ERROR)}})}},this)}},deleteCentralInvoice:function(){var a=this.getCentralList().selModel.getSelection();if(a.length==0){Ext.Msg.alert(DELETE_INVOICE_MSG_TITLE,DELETE_INVOICE_MSG_ALERT)}else{Ext.Msg.confirm(DELETE_INVOICE_MSG_TITLE,DELETE_INVOICE_MSG_CONFIRM,function(b,d){if(b=="yes"){var c=new Array();Ext.each(a,function(e){c.push(e.data)},this);Ext.Ajax.request({url:"invoice/deletes.html?",method:"POST",jsonData:c,scope:this,success:function(){this.getCentralList().getStore().load()},failure:function(){Ext.Msg.alert(DELETE_INVOICE_MSG_TITLE,DELETE_INVOICE_MSG_ERROR)}})}},this)}},exportInvoices:function(d,a){var e={};var c="";if(d==0){e=this.getSupplierList().params()}else{e=this.getCentralList().params()}var f="";for(var b in e){if(b=="dateTo"||b=="dateFrom"){f+="&"+b+"="+Ext.encode(e[b]).replace(/\"/g,"")}else{f+="&"+b+"="+e[b]}}window.open("invoice/export."+a+"?output="+a+"&"+f,"popup","menubar=no, status=no, scrollbars=yes")},searchSupplierInvoice:function(){this.getSupplierList().store.load({params:{start:0,page:1}})},searchCentralInvoice:function(){this.getCentralList().store.load({params:{start:0,page:1}})}});Ext.define("AM.model.Invoice",{extend:"Ext.data.Model",fields:["id","invoiceNo","invoiceDate","centerVendorName","vendorName","vendorId",{name:"productName",type:"string"},"money","status","statusString","type","note","createDate","processedInvoiceId","processedInvoiceNo","categoryName","authorName","authorId"],proxy:{type:"ajax",api:{read:"invoice/list.html",update:"invoice/update.html",create:"invoice/create.html",destroy:"invoice/deletes.html"},reader:{type:"json",root:"invoices",successProperty:"success",totalProperty:"totalCount"}}});Ext.define("AM.model.User",{extend:"Ext.data.Model",fields:["id","fullname","email","phone","address","username","status","groupNames","groupIds",{name:"createDateStr"},"createDate","modifyDateStr"]});Ext.define("AM.store.Invoice",{extend:"Ext.data.Store",model:"AM.model.Invoice",autoLoad:false,pageSize:20});Ext.data.Store.override({mySync:function(a){if(Ext.isObject(a)){this.on("write",function(c,b){if(Ext.isDefined(a.scope)){a.callback.call(a.scope)}else{a.callback.call(this)}c.un("write",a.callback)})}this.sync()}});Ext.define("AM.store.User",{extend:"Ext.data.Store",model:"AM.model.User",autoLoad:false,pageSize:20,proxy:{type:"ajax",api:{read:"user/list.html",update:"user/update.html"},reader:{type:"json",root:"users",totalProperty:"totalCount",successProperty:"success"}}});Ext.define("AM.view.Toolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.mytoolbar",initComponent:function(){this.items=[{text:HOME,tooltip:HOME,height:30,itemId:"homeItem",scale:"medium",iconCls:"icon-home"},"-",{text:SUPPLIER_INVOICES,tooltip:SUPPLIER_INVOICES,height:30,itemId:"supplierInvoiceItem"},"-",{text:CENTRAL_INVOICES,tooltip:CENTRAL_INVOICES,height:30,itemId:"centralInvoiceItem"},"-",{text:USERS,tooltip:USERS_TOOLTIP,height:30,scale:"medium",iconCls:"icon-users",itemId:"usersItem",hidden:!authenticate.isAdminRole},"->",{text:"Hi! "+username,iconCls:"icon-user",scale:"medium",iconAlign:"right",menu:{xtype:"menu",plain:true,items:{xtype:"buttongroup",columns:2,defaults:{xtype:"button",scale:"medium",iconAlign:"left"},items:[{text:EDIT_USER,iconCls:"icon-edit-user",colspan:2,width:130,handler:function(){var a=Ext.create("AM.view.user.EditUser");a.loadData(username)}},{xtype:"menuseparator",colspan:2,width:130},{colspan:2,text:LOGOUT,width:130,iconCls:"icon-logout",iconAlign:"left",handler:this.logout}]}}}];this.callParent(arguments)},logout:function(a){window.location="logout.html"}});Ext.define("AM.view.Viewport",{extend:"Ext.container.Viewport",requires:"AM.view.Toolbar",layout:"boder",style:{padding:"20px"},initComponent:function(){this.items={dockedItems:[{docked:"top",xtype:"mytoolbar"}]},this.callParent(arguments)}});Ext.define("AM.view.invoice.CentralEdit",{extend:"Ext.window.Window",alias:"widget.invoiceCentralEdit",title:CENTRAL_INVOICE,layout:"fit",modal:true,autoShow:true,width:500,resizable:false,initComponent:function(){var b=Ext.create("AM.store.User",{pageSize:20,proxy:{type:"ajax",api:{read:"user/lookupVendors.html?type=1"},reader:{type:"json",root:"users",successProperty:"success",totalProperty:"totalCount"}}});var a=Ext.create("AM.store.Invoice",{proxy:{type:"ajax",api:{read:"invoice/lookupInvoices.html"},reader:{type:"json",root:"invoices",successProperty:"success",totalProperty:"totalCount"}}});var e=Ext.create("AM.store.User",{pageSize:20,proxy:{type:"ajax",api:{read:"user/lookupVendors.html?type=2"},reader:{type:"json",root:"users",successProperty:"success",totalProperty:"totalCount"}}});var d=Ext.create("Ext.data.Store",{fields:["name","description"],proxy:{type:"ajax",api:{read:"invoice/lookupCategory.html"},reader:{type:"json",root:"categories",successProperty:"success",totalProperty:"totalCount"}}});var c=Ext.create("Ext.form.Panel",{bodyStyle:"padding:5px 5px 0",defaults:{anchors:"100%"},fieldDefaults:{msgTarget:"side",autoFitErrors:false},items:[{xtype:"textfield",name:"invoiceNo",fieldLabel:INVOICE_NO,width:400,allowBlank:false},{xtype:"fieldcontainer",fieldLabel:INVOICE_DATE,layout:"hbox",defaults:{hideLabel:true},items:[{xtype:"datefield",name:"invoiceDate",msgTarget:"side",autoFitErrors:false,maxValue:new Date(),format:"d/m/Y",allowBlank:false,plugins:[new Ext.ux.InputTextMask("99/99/9999")]},{xtype:"label",text:DATE_EXAMPLE,margin:"2 0 0 10"}]},{xtype:"combo",name:"categoryName",fieldLabel:CATEGORY_NAME,width:400,allowBlank:false,hideTrigger:true,typeAhead:false,minChars:1,store:d,listConfig:{getInnerTpl:function(){return'<div class="search-item"><p><b>{name}</b></p><p><i>({description})</i></div>'}},listeners:{scope:this,select:function(h,f){var g=f[0];if(g){h.setValue(g.data.name)}}}},{xtype:"combo",name:"centerVendorName",fieldLabel:CENTER_VENDOR_NO,width:400,hideTrigger:true,typeAhead:false,minChars:1,store:e,listConfig:{getInnerTpl:function(){return'<div class="search-item"><p><b>{username}</b></p><p><i>({address})</i></div>'}},listeners:{scope:this,select:function(i,g){var j=g[0];if(j){i.setValue(j.data.username);var f=this.child("form").child("#vendorName");var h=this.child("form").child("#processedInvoiceNo");if(j.data.username=="99902"){h.disable(true);h.setValue("");f.disable(true);f.setValue("")}else{h.enable(false);f.enable(false)}}}}},{xtype:"combo",name:"processedInvoiceNo",itemId:"processedInvoiceNo",fieldLabel:PROCESSED_INVOICE_NO,width:400,hideTrigger:true,typeAhead:false,minChars:1,store:a,listConfig:{getInnerTpl:function(){return'<div class="search-item">{invoiceNo}</div>'}},listeners:{scope:this,select:function(i,g){var h=g[0];if(h){i.setValue(h.data.invoiceNo);var f=this.child("form").child("#vendorName");f.setValue(h.data.vendorName);var j=this.child("form").child("#productName");j.setValue(h.data.productName)}}}},{xtype:"combo",fieldLabel:VENDOR_NAME,name:"vendorName",itemId:"vendorName",width:400,hideTrigger:true,typeAhead:false,minChars:1,store:b,listConfig:{getInnerTpl:function(){return'<div class="search-item">{username}<div>'}},listeners:{scope:this,select:function(i,h){var g=h[0];if(g){i.setValue(g.data.username);var f=this.child("form").child("#vendorId");f.setValue(g.data.id)}}}},{xtype:"hiddenfield",name:"type",value:1},{xtype:"textfield",fieldLabel:PRODUCT_NAME,name:"productName",itemId:"productName",width:400,allowBlank:false},{xtype:"textfield",fieldLabel:MONEY,name:"money",width:400,allowBlank:false,listeners:{change:function(g,f){f=f.replace(/\./gm,"");f=Ext.util.Format.number(f,"0,000");g.setValue(f)}}},{xtype:"textarea",fieldLabel:NOTE,name:"note",width:400,height:100,maxlength:100},{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"createDate"},{xtype:"hiddenfield",name:"authorId"}],buttons:[{text:SAVE,formBind:true,action:"save"},{text:CANCEL,scope:this,handler:this.close}]});this.items=[c];this.callParent(arguments)}});Ext.define("AM.view.invoice.CentralList",{extend:"Ext.grid.Panel",alias:"widget.invoiceCentralList",initComponent:function(){this.tbar={items:[{text:ADD,itemId:"add",iconCls:"icon-add",disabled:!(authenticate.isAdminRole||authenticate.isCreateRole)},"-",{text:DELETE,itemId:"delete",iconCls:"icon-delete",disabled:!(authenticate.isAdminRole||authenticate.isDeleteRole)},"-",{text:EXPORT_EXCEL,itemId:"export-excel",iconCls:"icon-export-excel"},{text:EXPORT_PDF,itemId:"export-pdf",iconCls:"icon-export-pdf"},"->",{xtype:"datefield",name:"dateFrom",itemId:"dateFrom",fieldLabel:FROM_DATE,labelAlign:"right",labelWidth:40,width:160,editable:false,format:"d/m/Y",maxValue:new Date(),value:new Date(new Date().getFullYear(),new Date().getMonth())},{xtype:"timefield",name:"timeFrom",itemId:"timeFrom",minValue:"00:00",maxValue:"23:59",value:"06:00",width:80},{xtype:"datefield",name:"dateTo",itemId:"dateTo",fieldLabel:TO_DATE,labelAlign:"right",labelWidth:40,width:160,editable:false,format:"d/m/Y",maxValue:new Date(),value:new Date()},{xtype:"timefield",name:"timeTo",itemId:"timeTo",minValue:"00:00",maxValue:"23:59",value:"23:59",width:80},"-",{xtype:"combo",itemId:"searchField",editable:false,displayField:"name",valueField:"value",queryMode:"local",value:"0",width:100,store:new Ext.data.Store({fields:["name","value"],data:[{name:ALL,value:"0"},{name:CATEGORY_NAME,value:"4"},{name:VENDOR_NAME,value:"2"},{name:INVOICE_NO,value:"1"},{name:PRODUCT_NAME,value:"3"}]})},"-",{xtype:"textfield",itemId:"keySearch"},"-",{text:SEARCH,itemId:"searchBtn",iconCls:"icon-search"}]};var a=Ext.create("AM.store.Invoice");a.on("beforeload",function(){a.getProxy().extraParams=this.params()},this);this.store=a;this.bbar={xtype:"pagingtoolbar",store:a,displayInfo:true};this.columns=[{header:"Id",width:30,hidden:true,dataIndex:"id"},{header:INVOICE_NO,dataIndex:"invoiceNo",flex:0.5},{header:INVOICE_DATE,dataIndex:"invoiceDate",flex:0.5},{header:CATEGORY_NAME,dataIndex:"categoryName",flex:0.5},{header:CENTER_VENDOR_NAME,dataIndex:"centerVendorName",flex:0.5},{header:VENDOR_NAME,dataIndex:"vendorName",flex:1},{header:PRODUCT_NAME,dataIndex:"productName",flex:1},{header:MONEY,dataIndex:"money",align:"right",renderer:Ext.util.Format.numberRenderer("0,000")},{header:PROCESSED_INVOICE_NO,dataIndex:"processedInvoiceNo",flex:0.5},{header:CREATE_DATE,dataIndex:"createDate",flex:0.7},{header:AUTHOR,dataIndex:"authorName"},];this.selModel=Ext.create("Ext.selection.CheckboxModel");this.callParent(arguments)},params:function(){var f=this.query("#dateFrom")[0].getValue();var a=this.query("#timeFrom")[0].getValue();var c=this.query("#timeTo")[0].getValue();var e=this.query("#dateTo")[0].getValue();var b=this.query("#keySearch")[0];var d=this.query("#searchField")[0];f.setHours(a.getHours(),a.getMinutes());e.setHours(c.getHours(),c.getMinutes());return{dateFrom:f,dateTo:e,searchKey:b.getValue(),searchField:d.value,isSearch:false,type:1}}});Ext.require("Ext.ux.InputTextMask");Ext.define("AM.view.invoice.SupplierEdit",{extend:"Ext.window.Window",alias:"widget.invoiceSupplierEdit",title:SUPPLIER_INVOICE,layout:"fit",modal:true,autoShow:true,width:500,resizable:false,isNewForm:true,initComponent:function(){var c=Ext.create("AM.store.User",{pageSize:10,proxy:{type:"ajax",api:{read:"user/lookupVendors.html?type=1"},reader:{type:"json",root:"users",successProperty:"success",totalProperty:"totalCount"}}});var b=Ext.create("Ext.data.Store",{fields:["name","description"],proxy:{type:"ajax",api:{read:"invoice/lookupCategory.html"},reader:{type:"json",root:"categories",successProperty:"success",totalProperty:"totalCount"}}});var a=Ext.create("Ext.form.Panel",{bodyStyle:"padding:5px 5px 0",defaults:{anchors:"100%"},fieldDefaults:{msgTarget:"side",autoFitErrors:false},items:[{xtype:"textfield",name:"invoiceNo",fieldLabel:INVOICE_NO,width:400,allowBlank:false},{xtype:"fieldcontainer",fieldLabel:INVOICE_DATE,layout:"hbox",defaults:{hideLabel:true},items:[{xtype:"datefield",name:"invoiceDate",msgTarget:"side",autoFitErrors:false,maxValue:new Date(),format:"d/m/Y",allowBlank:false,plugins:[new Ext.ux.InputTextMask("99/99/9999")]},{xtype:"label",text:DATE_EXAMPLE,margin:"2 0 0 10"}]},{xtype:"combo",name:"categoryName",fieldLabel:CATEGORY_NAME,width:400,allowBlank:false,hideTrigger:true,typeAhead:false,minChars:1,store:b,listConfig:{getInnerTpl:function(){return'<div class="search-item"><p><b>{name}</b></p><p><i>({description})</i></div>'}},listeners:{scope:this,select:function(f,d){var e=d[0];if(e){f.setValue(e.data.name)}}}},{xtype:"combo",fieldLabel:VENDOR_NAME,name:"vendorName",width:400,allowBlank:false,hideTrigger:true,typeAhead:false,minChars:1,store:c,listConfig:{getInnerTpl:function(){return'<div class="search-item">{username}<div>'}},listeners:{scope:this,select:function(f,e){var d=e[0];if(d){f.setValue(d.data.username)}}}},{xtype:"textfield",fieldLabel:PRODUCT_NAME,name:"productName",width:400,allowBlank:false},{xtype:"textfield",fieldLabel:MONEY,name:"money",width:400,allowBlank:false,listeners:{change:function(e,d){d=d.replace(/\./gm,"");d=Ext.util.Format.number(d,"0,000");e.setValue(d)}}},{xtype:"textarea",fieldLabel:NOTE,name:"note",width:400,height:100,maxlength:100},{xtype:"hiddenfield",name:"type",value:0},{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"createDate"},{xtype:"hiddenfield",name:"authorId"}],buttons:[{text:SAVE,formBind:true,action:"save",hidden:!(authenticate.isAdminRole||authenticate.isEditRole||(authenticate.isCreateRole&&this.isNewForm))},{text:CANCEL,scope:this,handler:this.close}]});this.items=[a];this.callParent(arguments)}});Ext.require(["Ext.ux.RowExpander"]);Ext.define("AM.view.invoice.SupplierList",{extend:"Ext.grid.Panel",alias:"widget.invoiceSupplierList",plugins:[{ptype:"rowexpander",rowBodyTpl:['<div id="expander"></div>'],pluginId:"expander"}],initComponent:function(){this.tbar={items:[{text:ADD,itemId:"add",iconCls:"icon-add",disabled:!(authenticate.isAdminRole||authenticate.isCreateRole)},"-",{text:DELETE,itemId:"delete",iconCls:"icon-delete",disabled:!(authenticate.isAdminRole||authenticate.isDeleteRole)},"-",{text:EXPORT_EXCEL,itemId:"export-excel",iconCls:"icon-export-excel"},{text:EXPORT_PDF,itemId:"export-pdf",iconCls:"icon-export-pdf"},"->",{xtype:"datefield",name:"dateFrom",itemId:"dateFrom",fieldLabel:FROM_DATE,labelAlign:"right",width:160,labelWidth:40,format:"d/m/Y",maxValue:new Date(),value:new Date(new Date().getFullYear(),new Date().getMonth())},{xtype:"timefield",name:"timeFrom",itemId:"timeFrom",minValue:"00:00",maxValue:"23:59",value:"06:00",width:80},{xtype:"datefield",name:"dateTo",itemId:"dateTo",fieldLabel:TO_DATE,labelAlign:"right",labelWidth:40,width:160,editable:false,format:"d/m/Y",maxValue:new Date(),value:new Date()},{xtype:"timefield",name:"timeTo",itemId:"timeTo",minValue:"00:00",maxValue:"23:59",value:"23:59",width:80},"-",{xtype:"combo",itemId:"searchField",editable:false,width:100,displayField:"name",valueField:"value",queryMode:"local",value:"0",store:new Ext.data.Store({fields:["name","value"],data:[{name:ALL,value:"0"},{name:CATEGORY_NAME,value:"4"},{name:VENDOR_NAME,value:"2"},{name:INVOICE_NO,value:"1"},{name:PRODUCT_NAME,value:"3"}]})},"-",{xtype:"textfield",itemId:"keySearch",emptyText:"Enter search invoices"},"-",{text:SEARCH,itemId:"searchBtn",iconCls:"icon-search"}]};var a=Ext.create("AM.store.Invoice");a.on("beforeload",function(){a.getProxy().extraParams=this.params()},this);this.store=a;this.bbar={xtype:"pagingtoolbar",store:a,displayInfo:true};this.columns=[{header:"Id",width:30,hidden:true,dataIndex:"id"},{header:INVOICE_NO,dataIndex:"invoiceNo",flex:0.5},{header:INVOICE_DATE,dataIndex:"invoiceDate",flex:0.5},{header:CATEGORY_NAME,dataIndex:"categoryName",flex:0.5},{header:VENDOR_NAME,dataIndex:"vendorName",flex:1},{header:PRODUCT_NAME,dataIndex:"productName",flex:1},{header:MONEY,dataIndex:"money",renderer:Ext.util.Format.numberRenderer("0,000"),align:"right"},{header:STATUS,dataIndex:"statusString",flex:0.5},{header:CREATE_DATE,dataIndex:"createDate",flex:0.7},{header:AUTHOR,dataIndex:"authorName"},];this.selModel=Ext.create("Ext.selection.CheckboxModel");this.callParent(arguments)},params:function(){var f=this.query("#dateFrom")[0].getValue();var a=this.query("#timeFrom")[0].getValue();var c=this.query("#timeTo")[0].getValue();var e=this.query("#dateTo")[0].getValue();var b=this.query("#keySearch")[0];var d=this.query("#searchField")[0];f.setHours(a.getHours(),a.getMinutes());e.setHours(c.getHours(),c.getMinutes());return{dateFrom:f,dateTo:e,searchKey:b.getValue(),searchField:d.value,isSearch:false,type:0}}});Ext.define("AM.view.user.Edit",{extend:"Ext.window.Window",alias:"widget.useredit",layout:"fit",modal:true,autoShow:true,width:500,resizable:false,initComponent:function(){this.groupsStore=Ext.create("Ext.data.Store",{autoDestroy:true,storeId:"groupsId",autoLoad:false,fields:["id","name","description"],proxy:{type:"ajax",api:{read:"user/groups.html"},reader:{type:"json",root:"groups",totalProperty:"totalCount",successProperty:"success"}}});var a=new Ext.XTemplate('<tpl for=".">','<div id="box{id}" class="databox" onclick="oncheck({id})">','<input name="groups" type="checkbox" id="group{id}" value="{id}"> ',"&nbsp;{name} - {description}</div>","</tpl>",'<div class="x-clear"></div>');this.items=[{xtype:"form",bodyStyle:"padding:5px 5px 0",defaults:{anchors:"100%"},fieldDefaults:{msgTarget:"side",autoFitErrors:false,width:400},items:[{xtype:"fieldset",title:USER_INFO,collapsible:true,items:[{xtype:"textfield",name:"fullname",itemId:"fullname",fieldLabel:USER_FULLNAME},{xtype:"textfield",vtype:"email",name:"email",itemId:"email",fieldLabel:USER_EMAIL},{xtype:"textfield",name:"phone",itemId:"phone",fieldLabel:USER_PHONE},{xtype:"textarea",name:"address",itemId:"address",fieldLabel:USER_ADDRESS}]},{xtype:"fieldset",title:USER_LOGIN_INFO,items:[{xtype:"textfield",name:"username",allowBlank:false,fieldLabel:USER_NAME},{xtype:"textfield",inputType:"password",name:"password",id:"pass",allowBlank:false,fieldLabel:USER_PASSWORD},{xtype:"textfield",inputType:"password",name:"rePassword",allowBlank:false,fieldLabel:USER_REPASSWORD,initialPassField:"pass"},{xtype:"fieldcontainer",fieldLabel:GROUP_NAME,layout:"hbox",items:[{xtype:"label"},{xtype:"dataview",name:"groups",autoScroll:true,store:this.groupsStore,tpl:a,height:200,width:295,style:"border:1px solid #99BBE8;background:#fff;",itemSelector:"div.thumder"}]},{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"status"}]}]}];this.buttons=[{text:SAVE,action:"save"},{text:CANCEL,scope:this,handler:this.close}];this.callParent(arguments)},extraParams:function(){var b=Ext.query("input[id*=group]:checked");var a=[];Ext.each(b,function(c){a.push(c.value)});return{groupIds:[a]}},selectedGroups:function(a){Ext.each(a,function(b){oncheck(b)})}});function oncheck(a){if(Ext.get("box"+a).hasCls("checked")){Ext.get("box"+a).removeCls("checked");Ext.get("group"+a).dom.checked=false}else{Ext.get("box"+a).addCls("checked");Ext.get("group"+a).dom.checked=true}}Ext.define("AM.view.user.EditUser",{extend:"Ext.window.Window",layout:"fit",modal:true,autoShow:true,width:500,resizable:false,title:EDIT_USER,initComponent:function(){this.items=[{xtype:"form",bodyStyle:"padding:5px 5px 0",defaults:{anchors:"100%"},fieldDefaults:{msgTarget:"side",autoFitErrors:false,width:400},items:[{xtype:"fieldset",title:USER_INFO,collapsible:true,items:[{xtype:"textfield",name:"fullname",itemId:"fullname",fieldLabel:USER_FULLNAME},{xtype:"textfield",vtype:"email",name:"email",itemId:"email",fieldLabel:USER_EMAIL},{xtype:"textfield",name:"phone",itemId:"phone",fieldLabel:USER_PHONE},{xtype:"textarea",name:"address",itemId:"address",fieldLabel:USER_ADDRESS}]},{xtype:"fieldset",title:USER_LOGIN_INFO,items:[{xtype:"textfield",name:"username",allowBlank:false,disabled:true,fieldLabel:USER_NAME},{xtype:"textfield",inputType:"password",name:"password",id:"pass",allowBlank:false,fieldLabel:USER_PASSWORD},{xtype:"textfield",inputType:"password",name:"rePassword",allowBlank:false,fieldLabel:USER_REPASSWORD,initialPassField:"pass"},{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"status"}]}]}];this.buttons=[{text:SAVE,scope:this,handler:function(){var a=this.down("form").getForm();var b=this;if(a.isValid()){a.submit({url:"user/update.html",method:"POST",success:function(c,d){b.close()},failure:function(c,d){}})}}},{text:CANCEL,scope:this,handler:this.close}];this.callParent(arguments)},loadData:function(a){Ext.Ajax.request({url:"user/getUser.html",method:"GET",params:{username:a},success:function(c){var e=Ext.decode(c.responseText);var b=Ext.create("AM.model.User");b.data=e;var d=this.down("form");d.loadRecord(b)},scope:this})}});Ext.define("AM.view.user.List",{extend:"Ext.grid.Panel",alias:"widget.userlist",initComponent:function(){this.tbar={items:[{text:ADD_USER,itemId:"add",iconCls:"icon-add"},"-",{text:DELETE_USER,itemId:"delete",iconCls:"icon-delete"},"-",{text:ACTIVATE_USER,itemId:"unlock",iconAlign:"right",iconCls:"icon-unlock"},{text:DEACTIVATE_USER,itemId:"lock",iconCls:"icon-lock"},"->",{xtype:"datefield",name:"dateFrom",itemId:"dateFrom",fieldLabel:FROM_DATE,labelAlign:"right",labelWidth:40,width:160,editable:false,format:"d/m/Y",maxValue:new Date(),value:new Date(new Date().getFullYear()-1,new Date().getMonth())},{xtype:"datefield",name:"dateTo",itemId:"dateTo",fieldLabel:TO_DATE,labelAlign:"right",labelWidth:40,width:160,editable:false,format:"d/m/Y",maxValue:new Date(),value:new Date()},"-",{xtype:"combo",itemId:"searchField",editable:false,displayField:"name",valueField:"value",queryMode:"local",value:"0",width:100,store:new Ext.data.Store({fields:["name","value"],data:[{name:ALL,value:"0"},{name:USER_FULLNAME,value:"1"},{name:USER_NAME,value:"2"},{name:USER_EMAIL,value:"3"},{name:USER_PHONE,value:"4"},]})},"-",{xtype:"textfield",itemId:"keySearch"},"-",{text:SEARCH,itemId:"searchBtn",iconCls:"icon-search"}]};var a=Ext.create("AM.store.User");a.on("beforeload",function(){a.getProxy().extraParams=this.params()},this);this.store=a;this.bbar={xtype:"pagingtoolbar",store:a,displayInfo:true};this.columns=[{header:"Id",width:30,hidden:true,dataIndex:"id"},{header:USER_NAME,dataIndex:"username",flex:1},{header:USER_EMAIL,dataIndex:"email",flex:1},{header:GROUP_NAME,dataIndex:"groupNames",flex:1},{header:MODIFY_DATE,dataIndex:"modifyDateStr",flex:0.5},{header:CREATE_DATE,dataIndex:"createDateStr",flex:0.5},{header:USER_STATUS,dataIndex:"status",renderer:function(b){return b==1?STATUS_ACTIVATED:STATUS_BLOCKED}}];this.selModel=Ext.create("Ext.selection.CheckboxModel");this.callParent(arguments)},params:function(){var d=this.query("#dateFrom")[0].getValue();var c=this.query("#dateTo")[0].getValue();var a=this.query("#keySearch")[0];var b=this.query("#searchField")[0];d.setHours(0,0);c.setHours(23,59);return{dateFrom:d,dateTo:c,searchKey:a.getValue(),searchField:b.value,isSearch:false,type:1}}});Ext.application({name:"AM",appFolder:"js/app",autoCreateViewport:false,controllers:["Apps","Users","Invoices"],layout:"fit",width:"100%",height:"100%",launch:function(){Ext.create("Ext.container.Viewport",{items:{dockedItems:[{xtype:"mytoolbar"}],items:[{xtype:"tabpanel",items:[{title:HOME,xtype:"container",itemId:"homeTab",loader:{url:"content.html?name=home",autoLoad:true,scope:this,success:function(){}}}]}]}})}});
